<!DOCTYPE html>
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
	<link rel="stylesheet" href="post.css">
    <script src="config.js"></script>	<!-- load global config   -->
	<script src="navigation.js"></script>	<!-- load navigation bar  -->
	<script src="marked.js"></script>	<!-- load markdown parser -->
    <script src="js-yaml.js"></script>
    <script src="yamlFront.js"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          extensions: ["tex2jax.js"],
          jax: ["input/TeX", "output/HTML-CSS"],
          tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
            processEscapes: true,
          },
          "HTML-CSS": { availableFonts: ["TeX"] }
        });
    </script>
</head>

<body>
	<nav id="navi"></nav> <!-- navigation container -->
	<div id="prev"></div> <!-- blog list container -->
	<div id="cont"></div> <!-- blog content container -->
	<div id="foot"></div> <!-- foot content container -->

	<!-- script for loading blog posts from source -->
	<script>
		let parameter = new URLSearchParams(window.location.search);
		// parse and render markdown content
		let file = new String(parameter.get("file")).split(/^\//, 1)[0].split(/\.md$/, 1)[0] + ".md";
		// parse markdown and do miscellanious after work
		fetch(post + file, {"credentials": "include"})
		.then(async (value) => await value.text())
        .then(text => {
            let new_text = text.replaceAll("\\\\", "\\\\\\\\");
            console.log(new_text);
            return new_text;
        })
		.then(text => {
            let oldLexerLex = marked.Lexer.lex;
            marked.Lexer.lex = function (text, options) {
                let parsed = yamlFront.loadFront(text)
                let cKey = '__content'
                return oldLexerLex(parsed[cKey], options)
            }
			document.getElementById("cont").innerHTML = marked.parse(text);
			return true; })
		.then(_any => {
            let head = document.getElementsByTagName("head")[0];
			let script = document.createElement("script");
			script.setAttribute("type", "text/javascript");
            script.setAttribute("src", site + "mathjax/MathJax.js");
			head.appendChild(script);
        })
        .then(_any => {
            // there should be a marked plugin called marked-base-url that can presumably do this job for me
            // but unfortunately there are some configuration that a non-frontend engineer can barely understand
            // redirect links
            for (let alink of document.querySelectorAll("#cont a")) {
                let path = alink.href.split(site)[1];
                if (path) {
                    alink.href = site + `post.html?file=${path}`;
                }
            }
            // redirect image path
            for (let image of document.querySelectorAll("#cont img")) {
                let path = image.src.split(site)[1];
                if (path) {
                    image.src = post + path;
                }
            }
        })
		// the table of meta information about all files
		/* ---------------------------------------------------------------- //
			{
				"<path>": {
					"topic": "about",
					"timestamp":  "2024-02-30",
				}
			}
		// ---------------------------------------------------------------- */
		fetch(info + "table-meta.json?nocache=" + (new Date()).toISOString().split('T')[0], {"credentials": "include"})
		.then(async (value) => await value.text())
		.then(JSON.parse)
		.then((tableMeta) => {
			let current = tableMeta[file]["topic"];
			let cntAnother = 0;
			let cntCurrent = 0;
			let arrAnother = [];
			let arrCurrent = [];
			const lenAnother = 3;
			const lenCurrent = 2; 
			for (let [key, val] of Object.entries(tableMeta)) {
				if (val["topic"] == current) {
					let randNum = Math.floor(Math.random() * cntCurrent);
					if (cntCurrent < lenCurrent) {
						arrCurrent.push([key, val]);
					} else if (randNum < lenCurrent) {
						arrCurrent[randNum] = [key, val];
					}
					cntCurrent += 1;
				} else {
					let randNum = Math.floor(Math.random() * cntAnother);
					if (cntAnother < lenAnother) {
						arrAnother.push([key, val]);
					} else if (randNum < lenAnother) {
						arrAnother[randNum] = [key, val];
					}
					cntAnother += 1;
				}
			}
			return arrAnother.concat(arrCurrent); 
		})
		.then((arrayMeta) => {
            console.log(arrayMeta);
			let prevList = document.getElementById("prev");
			for (let [href, info] of arrayMeta) {
				let prevItem = document.createElement("div");
				prevItem.setAttribute("class", "prev-item");
                let hrefRedirected = site + "post.html?file=" + href;
				prevItem.innerHTML = `
					<div class="prev-item-title">${info["title"]}</div>
					<div class="prev-item-ahref">
						<a href="${hrefRedirected}">READ -></a>
					</div>
				`;
                prevList.appendChild(prevItem);
			}
		})
	</script>
</body>
